import { Box, Container } from "@mui/material";
import React, { FC, useEffect, useState } from "react";
import { useAsync } from "react-use";

import { ACLHistoryList } from "../components/acl/ACLHistoryList";
import { PageHeader } from "../components/common/PageHeader";
import { EntityBreadcrumbs } from "../components/entity/EntityBreadcrumbs";
import { EntryBreadcrumbs } from "../components/entry/EntryBreadcrumbs";
import { useTypedParams } from "../hooks/useTypedParams";
import { DjangoContext } from "../services/DjangoContext";

import { EntityDetail, EntryRetrieve } from "apiclient/autogenerated";
import { Loading } from "components/common/Loading";
import { aironeApiClientV2 } from "repository/AironeApiClientV2";

export const ACLHistoryPage: FC = () => {
  const djangoContext = DjangoContext.getInstance();
  const { objectId } = useTypedParams<{ objectId: number }>();
  const [entity, setEntity] = useState<EntityDetail>();
  const [entry, setEntry] = useState<EntryRetrieve>();

  const acl = useAsync(async () => {
    return await aironeApiClientV2.getAcl(objectId);
  }, [objectId]);

  const aclHistory = useAsync(async () => {
    return await aironeApiClientV2.getAclHistory(objectId);
  }, [objectId]);

  useEffect(() => {
    switch (acl.value?.objtype) {
      case djangoContext?.aclObjectType.entity:
        aironeApiClientV2.getEntity(objectId).then((resp) => {
          setEntity(resp);
        });
        break;
      case djangoContext?.aclObjectType.entry:
        aironeApiClientV2.getEntry(objectId).then((resp) => {
          setEntry(resp);
        });
        break;
    }
  }, [acl]);

  return (
    <Box className="container-fluid">
      {entry != null && <EntryBreadcrumbs entry={entry} title="ACL変更履歴" />}
      {entity != null && (
        <EntityBreadcrumbs entity={entity} title="ACL変更履歴" />
      )}

      <PageHeader title={acl.value?.name ?? ""} description="ACL変更履歴" />

      {aclHistory.loading ? (
        <Loading />
      ) : (
        <Container>
          <ACLHistoryList histories={aclHistory.value ?? []} />
        </Container>
      )}
    </Box>
  );
};
